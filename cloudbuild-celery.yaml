# Cloud Build configuration for Celery Worker
# This configuration builds and deploys the Celery worker to Cloud Run Jobs

steps:
  # Build the Celery Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-f'
      - 'Dockerfile.celery'
      - '-t'
      - '${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
      - '-t'
      - '${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:latest'
      - '.'

  # Push the Docker image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:latest'

  # Deploy to Cloud Run Jobs
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'jobs'
      - 'deploy'
      - '${_JOB_NAME}'
      - '--image=${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
      - '--region=${_GCP_LOCATION}'
      - '--memory=512Mi'
      - '--max-retries=3'
      - '--parallelism=1'
      - '--set-env-vars=ENVIRONMENT=${_ENVIRONMENT},GCP_PROJECT_ID=${PROJECT_ID},GCP_LOCATION=${_GCP_LOCATION},GCP_STORAGE_BUCKET=${_GCP_STORAGE_BUCKET},FIRESTORE_COLLECTION_CHAT_HISTORY=${_FIRESTORE_COLLECTION_CHAT_HISTORY},FIRESTORE_COLLECTION_PROCESSED_MESSAGES=${_FIRESTORE_COLLECTION_PROCESSED_MESSAGES},WHATSAPP_PHONE_NUMBER_ID=${_WHATSAPP_PHONE_NUMBER_ID},WHATSAPP_BUSINESS_ACCOUNT_ID=${_WHATSAPP_BUSINESS_ACCOUNT_ID},OPENAI_MODEL=${_OPENAI_MODEL},LANGCHAIN_TRACING_V2=${_LANGCHAIN_TRACING_V2},PINECONE_INDEX_NAME=${_PINECONE_INDEX_NAME},TEMP_FILE_PATH=${_TEMP_FILE_PATH},JWT_ALGORITHM=${_JWT_ALGORITHM},JWT_ACCESS_TOKEN_EXPIRE_MINUTES=${_JWT_ACCESS_TOKEN_EXPIRE_MINUTES},DEBUG=${_DEBUG},LOG_LEVEL=${_LOG_LEVEL},API_HOST=${_API_HOST},API_PORT=${_API_PORT},OPENCV_VIDEOIO_PRIORITY_MSMF=0'
      - '--update-secrets=WEBHOOK_TOKEN=${_WEBHOOK_TOKEN_SECRET}:latest,WHATSAPP_API_TOKEN=${_WHATSAPP_API_TOKEN_SECRET}:latest,OPENAI_API_KEY=${_OPENAI_API_KEY_SECRET}:latest,LANGCHAIN_API_KEY=${_LANGCHAIN_API_KEY_SECRET}:latest,PINECONE_API_KEY=${_PINECONE_API_KEY_SECRET}:latest,JWT_SECRET_KEY=${_JWT_SECRET_KEY_SECRET}:latest'

# Substitution variables (can be overridden in trigger configuration)
substitutions:
  _GCP_LOCATION: 'asia-south1'
  _ARTIFACT_REGISTRY_REPO: 'whatsapp-chatbot-repo'
  _IMAGE_NAME: 'whatsapp-ai-celery-worker'
  _JOB_NAME: 'whatsapp-ai-celery-worker'
  _ENVIRONMENT: 'production'
  _GCP_STORAGE_BUCKET: ''
  _FIRESTORE_COLLECTION_CHAT_HISTORY: 'chat_history'
  _FIRESTORE_COLLECTION_PROCESSED_MESSAGES: 'processed_messages'
  _WHATSAPP_PHONE_NUMBER_ID: ''
  _WHATSAPP_BUSINESS_ACCOUNT_ID: ''
  _OPENAI_MODEL: 'gpt-4o-mini'
  _LANGCHAIN_TRACING_V2: 'false'
  _PINECONE_INDEX_NAME: ''
  _TEMP_FILE_PATH: '/tmp'
  _JWT_ALGORITHM: 'HS256'
  _JWT_ACCESS_TOKEN_EXPIRE_MINUTES: '30'
  _DEBUG: 'false'
  _LOG_LEVEL: 'INFO'
  _API_HOST: '0.0.0.0'
  _API_PORT: '8000'
  # Secret names in Secret Manager
  _WEBHOOK_TOKEN_SECRET: 'WEBHOOK_TOKEN'
  _WHATSAPP_API_TOKEN_SECRET: 'WHATSAPP_API_TOKEN'
  _OPENAI_API_KEY_SECRET: 'OPENAI_API_KEY'
  _LANGCHAIN_API_KEY_SECRET: 'LANGCHAIN_API_KEY'
  _PINECONE_API_KEY_SECRET: 'PINECONE_API_KEY'
  _JWT_SECRET_KEY_SECRET: 'JWT_SECRET_KEY'

# Timeout for the build
timeout: '1800s'

# Build options
options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Images to be pushed to Artifact Registry
images:
  - '${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
  - '${_GCP_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_IMAGE_NAME}:latest'
